<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Generador de Informes</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body data-user-role="{{ user.role if user else '' }}">
    <main class="shell">
      <header class="hero admin-hero">
        <button
          type="button"
          class="theme-toggle"
          id="themeToggle"
          aria-label="Cambiar tema"
          aria-pressed="false"
          title="Cambiar tema"
        >
          <span class="theme-icon" aria-hidden="true"></span>
        </button>
        <div>
          <h1>Generador de Informes</h1>
          <p>
            Completa los campos y genera los tres documentos con un solo clic.
          </p>
        </div>
        <div class="hero-actions">
          {% if user and user.role == "super_admin" %}
          <a class="secondary" href="/admin">Admin</a>
          {% endif %} {% if user %}
          <span class="user-chip">{{ user.username }} ({{ user.role }})</span>
          <a class="secondary" href="/logout">Salir</a>
          {% endif %}
        </div>
      </header>

      {# Supervisor Review Section #} {% if user and user.role == "supervisor"
      %}
      <section class="supervisor-review">
        <div id="supervisor-review-section" style="display: none">
          <div class="supervisor-heading">
            <h2>Panel de Supervisión</h2>
            <p>
              Selecciona un informe en el menú lateral para revisar y decidir.
            </p>
          </div>
          <div class="supervisor-topbar">
            <div class="supervisor-breadcrumb">
              <span>Inicio</span>
              <span aria-hidden="true">/</span>
              <strong>Panel de Supervisión</strong>
            </div>
            <div class="supervisor-topbar-actions">
              <span id="supervisor-last-sync" class="supervisor-sync-pill"
                >Actualizando...</span
              >
              <button
                type="button"
                class="secondary"
                id="supervisor-refresh-btn"
              >
                Actualizar panel
              </button>
            </div>
          </div>
          <div class="supervisor-layout">
            <aside class="supervisor-sidebar">
              <nav
                class="supervisor-side-nav"
                aria-label="Navegación supervisor"
              >
                <button
                  type="button"
                  class="supervisor-side-link is-active"
                  data-status=""
                >
                  <span class="supervisor-side-icon" aria-hidden="true">▦</span>
                  <span>Informes</span>
                </button>
                <button
                  type="button"
                  class="supervisor-side-link"
                  data-status="pendiente"
                >
                  <span class="supervisor-side-icon" aria-hidden="true"
                    >⏳</span
                  >
                  <span>Pendientes</span>
                </button>
                <button
                  type="button"
                  class="supervisor-side-link"
                  data-status="aprobado"
                >
                  <span class="supervisor-side-icon" aria-hidden="true">✓</span>
                  <span>Aprobados</span>
                </button>
                <button
                  type="button"
                  class="supervisor-side-link"
                  data-status="rechazado"
                >
                  <span class="supervisor-side-icon" aria-hidden="true">✕</span>
                  <span>Rechazados</span>
                </button>
              </nav>
              <div class="supervisor-filters">
                <input
                  type="text"
                  id="filter-contractor"
                  placeholder="Filtrar por contratista"
                />
                <input type="month" id="filter-period" />
                <select id="filter-status">
                  <option value="">Todos los estados</option>
                  <option value="pendiente">Pendiente</option>
                  <option value="aprobado">Aprobado</option>
                  <option value="rechazado">Rechazado</option>
                </select>
                <button id="btn-filter-reports">Filtrar</button>
              </div>
              <div id="supervisor-reports-menu" class="supervisor-reports-menu">
                <!-- JS: Llenar con informes -->
              </div>
            </aside>
            <div class="supervisor-content">
              <div class="supervisor-stats" aria-live="polite">
                <article class="supervisor-stat-card">
                  <span>Total</span>
                  <strong id="supervisor-stat-total">0</strong>
                </article>
                <article class="supervisor-stat-card is-pending">
                  <span>Pendientes</span>
                  <strong id="supervisor-stat-pending">0</strong>
                </article>
                <article class="supervisor-stat-card is-approved">
                  <span>Aprobados</span>
                  <strong id="supervisor-stat-approved">0</strong>
                </article>
                <article class="supervisor-stat-card is-rejected">
                  <span>Rechazados</span>
                  <strong id="supervisor-stat-rejected">0</strong>
                </article>
              </div>
              <div id="supervisor-empty-state" class="supervisor-empty-state">
                Selecciona un informe para visualizar el detalle de actividades.
              </div>
              <div id="supervisor-review-panel" style="display: none">
                <h3>Detalle del Informe</h3>
                <div class="supervisor-selected-summary">
                  <div class="supervisor-selected-head">
                    <strong id="supervisor-selected-title">Informe</strong>
                    <span id="supervisor-selected-meta"
                      >Selecciona un informe para ver sus datos.</span
                    >
                  </div>
                  <div class="supervisor-detail-grid">
                    <div class="supervisor-detail-item">
                      <span>Contratista</span>
                      <strong id="supervisor-detail-contractor">-</strong>
                    </div>
                    <div class="supervisor-detail-item">
                      <span>No. Contrato</span>
                      <strong id="supervisor-detail-contract">-</strong>
                    </div>
                    <div
                      class="supervisor-detail-item supervisor-detail-item--full"
                    >
                      <span>Objeto contractual</span>
                      <p id="supervisor-detail-object">
                        Sin información registrada.
                      </p>
                    </div>
                  </div>
                </div>
                <div id="supervisor-activities-list">
                  <!-- JS: Llenar con actividades -->
                </div>
                <div class="supervisor-global-controls">
                  <label for="supervisor-global-observation"
                    >Observación global:</label
                  >
                  <textarea
                    id="supervisor-global-observation"
                    rows="2"
                  ></textarea>
                  <div class="supervisor-global-actions">
                    <button id="supervisor-approve-report">
                      Aprobar informe
                    </button>
                    <button id="supervisor-reject-report">
                      Rechazar informe
                    </button>
                    <button id="supervisor-save-draft">
                      Guardar revisión parcial
                    </button>
                  </div>
                </div>
                <div id="supervisor-review-history">
                  <h4>Historial de revisiones</h4>
                  <ul id="supervisor-history-list">
                    <!-- JS: Llenar con historial -->
                  </ul>
                </div>
                <div id="supervisor-notification" style="display: none">
                  <span>Notificación enviada al contratista.</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <hr />
      {% endif %}

      <section class="tabs">
        <nav class="tablist">
          <button class="tab active" data-tab="t1">1. Datos Generales</button>
          <button class="tab" data-tab="t2">2. Obligaciones Directas</button>
          <button class="tab" data-tab="t4">3. Seguridad Social</button>
          <button class="tab" data-tab="t5">4. Informacion Financiera</button>
        </nav>

        <form id="form" class="tabpanels">
          <div class="panel active" id="t1">
            <div class="grid">
              <label
                >Numero de informe<input name="informe_no" required
              /></label>
              <label>Contrato No<input name="contrato_no" required /></label>
              <label>
                Fecha contrato<input
                  name="fecha_contrato"
                  type="date"
                  required
                />
              </label>
              <label
                >Objeto contractual<textarea
                  name="objeto_contractual"
                  required
                ></textarea>
              </label>
              <label
                >Entidad contratante<input name="entidad_contratante" required
              /></label>
              <label>NIT ENTIDAD<input name="nit" required /></label>
              <label
                >Nombre Completo (Contratista)<input
                  name="contratista"
                  required
              /></label>
              <label>CC<input name="cc" required /></label>
              <label
                >Ciudad de expedicion<input name="ciudad_expedicion" required
              /></label>
              <label>
                Supervisor
                <select name="supervisor" required>
                  <option value="">Selecciona</option>
                  {% for sup in supervisors %}
                  <option
                    value="{{ sup.first_name }} {{ sup.last_name }}"
                    data-doc-number="{{ sup.doc_number }}"
                  >
                    {{ sup.first_name }} {{ sup.last_name }}
                  </option>
                  {% endfor %}
                </select>
              </label>
              <label
                >CC supervisor<input
                  name="supervisor_cc"
                  readonly
                  placeholder="Se completa al seleccionar supervisor"
              /></label>
              <div class="plazo-group">
                <div class="group-title">Plazo inicial</div>
                <div class="plazo-grid">
                  <label>
                    Plazo (año)
                    <select name="plazo_anio" required>
                      <option value="">Año</option>
                    </select>
                  </label>
                  <label>
                    Plazo (mes)
                    <select name="plazo_mes" required>
                      <option value="">Mes</option>
                    </select>
                  </label>
                  <label>
                    Plazo (dia)
                    <select name="plazo_dia" required>
                      <option value="">Dia</option>
                    </select>
                  </label>
                </div>
              </div>
              <label>
                Fecha inicio contrato<input
                  name="fecha_inicio_contrato"
                  type="date"
                  required
              /></label>
              <label>
                Fecha vencimiento contrato<input
                  name="fecha_vencimiento_contrato"
                  type="date"
                  required
              /></label>
              <label
                >Valor inicial<input
                  name="valor_inicial"
                  required
                  class="money"
              /></label>
              <label>CDP<input name="cdp" required /></label>
              <label>RP<input name="rp" required /></label>
              <div class="plazo-group">
                <div class="group-title">Periodo informado</div>
                <div class="plazo-grid">
                  <label>
                    Periodo informado (de)<input
                      name="periodo_i_de"
                      type="date"
                      required
                  /></label>
                  <label>
                    Periodo informado (a)<input
                      name="periodo_i_a"
                      type="date"
                      required
                  /></label>
                </div>
              </div>
              <label
                >Fecha expedicion informe (año)
                <select name="fecha_expedicion_informe_año" required>
                  <option value="">Año</option>
                </select>
              </label>
              <label
                >Fecha expedicion informe (mes)
                <select name="fecha_expedicion_informe_mes" required>
                  <option value="">Mes</option>
                </select>
              </label>
              <label
                >Fecha expedicion informe (dia)
                <select name="fecha_expedicion_informe_dia" required>
                  <option value="">Dia</option>
                </select>
              </label>
              <label
                >Fecha presentacion informe<input
                  name="fecha_presentacion_informe"
                  type="text"
                  placeholder="dd/mm/aaaa"
                  required
              /></label>
            </div>
          </div>

          <div class="panel" id="t2">
            <section class="activity-section directa" id="directas">
              {% if user and user.role == "contratista" %}
              <div class="info-note">
                En el campo Actividades ejecutadas, redacta en primera persona.
              </div>
              {% endif %}
              <div class="activity-header">
                <span>Actividades del contrato</span>
                <span>Actividades ejecutadas</span>
                <span>Aporta evidencias?</span>
              </div>
              <div class="activity-rows" id="directasRows">
                <div class="activity-row">
                  <textarea
                    name="obligaciones_directas_item"
                    required
                  ></textarea>
                  <textarea
                    name="obligaciones_directas_ejecutadas_item"
                    required
                  ></textarea>
                  <select
                    name="obligaciones_directas_aporta_evidencias_item"
                    required
                  >
                    <option value="">Selecciona</option>
                    <option value="SI">SI</option>
                    <option value="NO">NO</option>
                  </select>
                  <button type="button" class="icon-button" title="Eliminar">
                    Eliminar
                  </button>
                </div>
              </div>
              <button type="button" class="secondary" id="addDirecta">
                Agregar actividad
              </button>
            </section>
          </div>

          <div class="panel" id="t4">
            <div class="grid">
              <label
                >No. planilla<input name="aportes_planilla" required
              /></label>
              <label
                >Mes de aporte<input name="aportes_mes" type="month" required
              /></label>
              <label
                >Fecha pago aportes<input
                  name="fecha_pago_aportes"
                  type="date"
                  required
              /></label>
              <label
                >Operador planilla<input name="operador_planilla" required
              /></label>
              <label
                >Valor salud<input
                  name="aportes_valor_salud"
                  required
                  class="money"
              /></label>
              <label
                >Valor pension<input
                  name="aportes_valor_pension"
                  required
                  class="money"
              /></label>
              <label
                >Valor riesgos<input
                  name="aportes_valor_riesgos"
                  required
                  class="money"
              /></label>
              <label
                >Total aportes<input
                  name="total_aportes"
                  readonly
                  class="money"
              /></label>
            </div>
          </div>

          <div class="panel" id="t5">
            <section class="actas-section">
              <div class="actas-header">
                <span>Acta parcial</span>
                <span>Periodo</span>
                <span>Valor</span>
              </div>
              <div class="actas-rows" id="actasRows">
                <div class="actas-row">
                  <input name="acta_parcial_item" required />
                  <input name="acta_parcial_periodo_item" required />
                  <input
                    name="acta_parcial_valor_item"
                    required
                    class="money"
                  />
                  <button type="button" class="icon-button" title="Eliminar">
                    Eliminar
                  </button>
                </div>
              </div>
              <button type="button" class="secondary" id="addActa">
                Agregar acta
              </button>
            </section>

            <div class="grid">
              <label
                >Subtotal actas<input
                  name="actas_subtotal"
                  readonly
                  class="money"
              /></label>
              <label
                >Valor del contrato<input
                  name="valor_contrato"
                  required
                  class="money"
              /></label>
              <label
                >Valor anticipo<input
                  name="valor_anticipo"
                  required
                  class="money"
              /></label>
              <label
                >Valor pago anticipado<input
                  name="valor_pago_anticipado"
                  required
                  class="money"
              /></label>
              <label
                >Valor adiciones<input
                  name="valor_adiciones"
                  required
                  class="money"
              /></label>
              <label
                >Valor ejecutado<input
                  name="valor_ejecutado"
                  required
                  class="money"
                  readonly
              /></label>
              <label
                >Valor a cobrar<input
                  name="valor_a_cobrar"
                  required
                  class="money"
              /></label>
              <label
                >Saldo pendiente<input
                  name="saldo_pendiente"
                  required
                  class="money"
              /></label>
              <label
                >Valor presente informe<input
                  name="valor_presente_informe"
                  required
                  class="money"
              /></label>
            </div>

            <div class="actions">
              <button
                type="submit"
                class="primary is-disabled"
                aria-disabled="true"
              >
                Generar documentos
              </button>
              <span id="status"></span>
            </div>
          </div>
        </form>

        <div class="history-separator" aria-hidden="true"></div>
        <section class="history" aria-live="polite">
          <div class="history-header">
            <h2>Historial</h2>
            <button type="button" class="secondary" id="refreshHistory">
              Actualizar
            </button>
          </div>
          <div class="history-list" id="historyList">
            <span class="history-empty">Sin registros aun.</span>
          </div>
        </section>
      </section>
    </main>

    <div class="modal" id="statusModal" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true">
        <h3 id="modalTitle">Estado</h3>
        <div id="modalBody"></div>
        <div class="modal-actions">
          <button type="button" class="primary" id="closeModal">Cerrar</button>
        </div>
      </div>
    </div>

    <div class="modal" id="evidenceModal" aria-hidden="true">
      <div class="modal-card modal-card--wide" role="dialog" aria-modal="true">
        <h3>Evidencias</h3>
        <div
          class="evidence-tabs"
          role="tablist"
          aria-label="Tipo de evidencia"
        >
          <button
            type="button"
            class="evidence-tab is-active"
            id="evidenceTabPhotos"
            data-evidence-tab="photos"
            role="tab"
            aria-selected="true"
          >
            Evidencia fotografica
          </button>
          <button
            type="button"
            class="evidence-tab"
            id="evidenceTabPdfs"
            data-evidence-tab="pdfs"
            role="tab"
            aria-selected="false"
          >
            Evidencia PDF
          </button>
        </div>
        <div
          class="evidence-pane is-active"
          id="evidencePanePhotos"
          role="tabpanel"
        >
          <div class="evidence-controls">
            <input
              type="file"
              id="evidenceFiles"
              accept="image/*"
              multiple
              hidden
            />
            <button type="button" class="secondary" id="addEvidenceFiles">
              Agregar fotos
            </button>
            <span class="evidence-hint">
              Se agrupan automaticamente en bloques de 3 fotos.
            </span>
          </div>
          <div id="evidenceGroups" class="evidence-groups"></div>
        </div>
        <div
          class="evidence-pane"
          id="evidencePanePdfs"
          role="tabpanel"
          aria-hidden="true"
        >
          <div class="evidence-controls">
            <input
              type="file"
              id="evidencePdfFiles"
              accept="application/pdf,.pdf"
              multiple
              hidden
            />
            <button type="button" class="secondary" id="addEvidencePdfFiles">
              Agregar PDF
            </button>
            <span class="evidence-hint">
              Adjunta uno o varios archivos PDF como soporte.
            </span>
          </div>
          <div id="evidencePdfs" class="evidence-pdfs"></div>
        </div>
        <div class="modal-actions">
          <button type="button" class="secondary" id="evidenceCancel">
            Cancelar
          </button>
          <button type="button" class="primary" id="evidenceSave">
            Guardar
          </button>
        </div>
      </div>
    </div>

    <script>
      const TAB_KEY = "tab_id";
      const ensureTabId = () => {
        let tabId = sessionStorage.getItem(TAB_KEY);
        if (!tabId) {
          tabId =
            (window.crypto && crypto.randomUUID && crypto.randomUUID()) ||
            `${Date.now()}-${Math.random().toString(16).slice(2)}`;
          sessionStorage.setItem(TAB_KEY, tabId);
        }
        return tabId;
      };

      const tabId = ensureTabId();

      document.querySelectorAll("a[href^='/']").forEach((link) => {
        const rawHref = link.getAttribute("href");
        if (!rawHref) {
          return;
        }
        const url = new URL(rawHref, window.location.origin);
        url.searchParams.set("tab_id", tabId);
        link.setAttribute("href", url.toString());
      });

      document.querySelectorAll("form").forEach((form) => {
        if (form.querySelector("input[name='tab_id']")) {
          return;
        }
        const hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = "tab_id";
        hidden.value = tabId;
        form.appendChild(hidden);
      });

      const originalFetch = window.fetch.bind(window);
      window.fetch = (input, init = {}) => {
        const headers = new Headers(init.headers || {});
        headers.set("X-Tab-Id", tabId);
        return originalFetch(input, { ...init, headers });
      };

      const tabs = document.querySelectorAll(".tab");
      const outputDir = "{{ output_dir|e }}";
      const panels = document.querySelectorAll(".panel");
      const statusEl = document.getElementById("status");
      const historyList = document.getElementById("historyList");
      const refreshHistoryButton = document.getElementById("refreshHistory");
      const statusModal = document.getElementById("statusModal");
      const modalTitle = document.getElementById("modalTitle");
      const modalBody = document.getElementById("modalBody");
      const closeModalButton = document.getElementById("closeModal");
      const evidenceModal = document.getElementById("evidenceModal");
      const evidenceGroups = document.getElementById("evidenceGroups");
      const evidencePdfs = document.getElementById("evidencePdfs");
      const evidenceFilesInput = document.getElementById("evidenceFiles");
      const evidencePdfFilesInput = document.getElementById("evidencePdfFiles");
      const addEvidenceFilesButton =
        document.getElementById("addEvidenceFiles");
      const addEvidencePdfFilesButton = document.getElementById(
        "addEvidencePdfFiles",
      );
      const evidenceCancelButton = document.getElementById("evidenceCancel");
      const evidenceSaveButton = document.getElementById("evidenceSave");
      const evidenceTabButtons = Array.from(
        document.querySelectorAll("[data-evidence-tab]"),
      );
      const themeToggle = document.getElementById("themeToggle");
      const applyTheme = (theme) => {
        document.body.dataset.theme = theme;
        if (themeToggle) {
          const isDark = theme === "dark";
          themeToggle.setAttribute("aria-pressed", isDark.toString());
          themeToggle.title = isDark
            ? "Cambiar a tema claro"
            : "Cambiar a tema oscuro";
        }
      };

      const savedTheme = localStorage.getItem("theme");
      const prefersDark = window.matchMedia(
        "(prefers-color-scheme: dark)",
      ).matches;
      applyTheme(savedTheme || (prefersDark ? "dark" : "light"));

      if (themeToggle) {
        themeToggle.addEventListener("click", () => {
          const nextTheme =
            document.body.dataset.theme === "dark" ? "light" : "dark";
          localStorage.setItem("theme", nextTheme);
          applyTheme(nextTheme);
        });
      }
      const openModal = (title, bodyHtml) => {
        modalTitle.textContent = title;
        modalBody.innerHTML = bodyHtml;
        statusModal.classList.add("is-open");
        statusModal.setAttribute("aria-hidden", "false");
      };

      const escapeHtml = (value) =>
        String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#39;");

      const evidenceByRow = new Map();
      let activeEvidenceId = null;
      let activeEvidenceDraft = null;
      let activeEvidenceTab = "photos";

      const createEvidenceId = () =>
        `${Date.now()}-${Math.random().toString(16).slice(2)}`;

      const cloneEvidence = (value) =>
        value
          ? {
              images: Array.isArray(value.images)
                ? JSON.parse(JSON.stringify(value.images))
                : [],
              groups: Array.isArray(value.groups)
                ? JSON.parse(JSON.stringify(value.groups))
                : [],
              pdfs: Array.isArray(value.pdfs)
                ? JSON.parse(JSON.stringify(value.pdfs))
                : [],
            }
          : { images: [], groups: [], pdfs: [] };

      const normalizeEvidenceGroups = (evidence) => {
        const totalGroups = Math.ceil(evidence.images.length / 3);
        while (evidence.groups.length < totalGroups) {
          evidence.groups.push({ description: "", date: "" });
        }
        if (evidence.groups.length > totalGroups) {
          evidence.groups = evidence.groups.slice(0, totalGroups);
        }
      };

      const setEvidenceTab = (tabName) => {
        activeEvidenceTab = tabName === "pdfs" ? "pdfs" : "photos";
        evidenceTabButtons.forEach((button) => {
          const isActive = button.dataset.evidenceTab === activeEvidenceTab;
          button.classList.toggle("is-active", isActive);
          button.setAttribute("aria-selected", isActive ? "true" : "false");
        });

        const photosPane = document.getElementById("evidencePanePhotos");
        const pdfsPane = document.getElementById("evidencePanePdfs");
        if (photosPane) {
          const isPhotos = activeEvidenceTab === "photos";
          photosPane.classList.toggle("is-active", isPhotos);
          photosPane.setAttribute("aria-hidden", isPhotos ? "false" : "true");
        }
        if (pdfsPane) {
          const isPdfs = activeEvidenceTab === "pdfs";
          pdfsPane.classList.toggle("is-active", isPdfs);
          pdfsPane.setAttribute("aria-hidden", isPdfs ? "false" : "true");
        }
      };

      const renderPdfEvidence = () => {
        if (!evidencePdfs || !activeEvidenceDraft) {
          return;
        }
        evidencePdfs.innerHTML = "";
        if (!activeEvidenceDraft.pdfs.length) {
          const empty = document.createElement("p");
          empty.className = "evidence-empty";
          empty.textContent = "Aun no has agregado archivos PDF.";
          evidencePdfs.appendChild(empty);
          return;
        }

        const list = document.createElement("div");
        list.className = "evidence-pdf-list";
        activeEvidenceDraft.pdfs.forEach((pdf, index) => {
          const row = document.createElement("div");
          row.className = "evidence-pdf-item";

          const name = document.createElement("span");
          name.className = "evidence-pdf-name";
          name.textContent = pdf.name || `Documento ${index + 1}`;

          const removeButton = document.createElement("button");
          removeButton.type = "button";
          removeButton.className = "secondary evidence-remove";
          removeButton.textContent = "Quitar";
          removeButton.addEventListener("click", () => {
            activeEvidenceDraft.pdfs.splice(index, 1);
            renderPdfEvidence();
          });

          row.appendChild(name);
          row.appendChild(removeButton);
          list.appendChild(row);
        });
        evidencePdfs.appendChild(list);
      };

      const renderEvidenceModal = () => {
        evidenceGroups.innerHTML = "";
        if (!activeEvidenceDraft) {
          return;
        }
        normalizeEvidenceGroups(activeEvidenceDraft);
        if (!activeEvidenceDraft.images.length) {
          const empty = document.createElement("p");
          empty.className = "evidence-empty";
          empty.textContent = "Aun no has agregado fotos.";
          evidenceGroups.appendChild(empty);
          return;
        }

        activeEvidenceDraft.groups.forEach((group, groupIndex) => {
          const groupCard = document.createElement("div");
          groupCard.className = "evidence-group";

          const groupTitle = document.createElement("h4");
          groupTitle.textContent = `Grupo ${groupIndex + 1}`;
          groupCard.appendChild(groupTitle);

          const grid = document.createElement("div");
          grid.className = "evidence-grid";
          const startIndex = groupIndex * 3;
          const chunk = activeEvidenceDraft.images.slice(
            startIndex,
            startIndex + 3,
          );
          chunk.forEach((image, offset) => {
            const cell = document.createElement("div");
            cell.className = "evidence-item";
            const img = document.createElement("img");
            img.src = image.dataUrl;
            img.alt = image.name || "Evidencia";
            const removeButton = document.createElement("button");
            removeButton.type = "button";
            removeButton.className = "secondary evidence-remove";
            removeButton.textContent = "Quitar";
            removeButton.addEventListener("click", () => {
              const removeIndex = startIndex + offset;
              activeEvidenceDraft.images.splice(removeIndex, 1);
              renderEvidenceModal();
            });
            cell.appendChild(img);
            cell.appendChild(removeButton);
            grid.appendChild(cell);
          });
          groupCard.appendChild(grid);

          const fields = document.createElement("div");
          fields.className = "evidence-fields";

          const descriptionLabel = document.createElement("label");
          descriptionLabel.textContent = "Descripcion";
          const descriptionInput = document.createElement("textarea");
          descriptionInput.value = group.description || "";
          descriptionInput.addEventListener("input", (event) => {
            group.description = event.target.value;
          });
          descriptionLabel.appendChild(descriptionInput);

          const dateLabel = document.createElement("label");
          dateLabel.textContent = "Fecha";
          const dateInput = document.createElement("input");
          dateInput.type = "date";
          dateInput.value = group.date || "";
          dateInput.addEventListener("input", (event) => {
            group.date = event.target.value;
          });
          dateLabel.appendChild(dateInput);

          fields.appendChild(descriptionLabel);
          fields.appendChild(dateLabel);
          groupCard.appendChild(fields);
          evidenceGroups.appendChild(groupCard);
        });

        renderPdfEvidence();
      };

      const openEvidenceModal = (row) => {
        if (!row) {
          return;
        }
        const evidenceId = row.dataset.evidenceId;
        activeEvidenceId = evidenceId;
        activeEvidenceDraft = cloneEvidence(evidenceByRow.get(evidenceId));
        setEvidenceTab("photos");
        renderEvidenceModal();
        evidenceModal.classList.add("is-open");
        evidenceModal.setAttribute("aria-hidden", "false");
      };

      const closeEvidenceModal = () => {
        evidenceModal.classList.remove("is-open");
        evidenceModal.setAttribute("aria-hidden", "true");
        activeEvidenceId = null;
        activeEvidenceDraft = null;
        if (evidenceFilesInput) {
          evidenceFilesInput.value = "";
        }
        if (evidencePdfFilesInput) {
          evidencePdfFilesInput.value = "";
        }
      };

      let activeEjecutadasField = null;
      let suppressEjecutadasModal = false;
      let isEjecutadasModal = false;

      const closeModal = () => {
        statusModal.classList.remove("is-open");
        statusModal.setAttribute("aria-hidden", "true");
        if (isEjecutadasModal && activeEjecutadasField) {
          suppressEjecutadasModal = true;
          const fieldToFocus = activeEjecutadasField;
          setTimeout(() => fieldToFocus.focus(), 0);
        }
        isEjecutadasModal = false;
      };

      const readFileAsDataUrl = (file) =>
        new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(new Error("read_failed"));
          reader.readAsDataURL(file);
        });

      if (addEvidenceFilesButton && evidenceFilesInput) {
        addEvidenceFilesButton.addEventListener("click", () => {
          evidenceFilesInput.click();
        });

        evidenceFilesInput.addEventListener("change", async (event) => {
          if (!activeEvidenceDraft) {
            return;
          }
          const files = Array.from(event.target.files || []);
          const images = files.filter((file) => file.type.startsWith("image/"));
          if (!images.length) {
            return;
          }
          const dataUrls = await Promise.all(
            images.map(async (file) => ({
              name: file.name,
              dataUrl: await readFileAsDataUrl(file),
            })),
          );
          activeEvidenceDraft.images.push(...dataUrls);
          renderEvidenceModal();
          evidenceFilesInput.value = "";
        });
      }

      if (addEvidencePdfFilesButton && evidencePdfFilesInput) {
        addEvidencePdfFilesButton.addEventListener("click", () => {
          evidencePdfFilesInput.click();
        });

        evidencePdfFilesInput.addEventListener("change", async (event) => {
          if (!activeEvidenceDraft) {
            return;
          }
          const files = Array.from(event.target.files || []);
          const pdfFiles = files.filter(
            (file) =>
              file.type === "application/pdf" ||
              file.name.toLowerCase().endsWith(".pdf"),
          );
          if (!pdfFiles.length) {
            return;
          }
          const dataUrls = await Promise.all(
            pdfFiles.map(async (file) => ({
              name: file.name,
              dataUrl: await readFileAsDataUrl(file),
            })),
          );
          activeEvidenceDraft.pdfs.push(...dataUrls);
          renderPdfEvidence();
          evidencePdfFilesInput.value = "";
        });
      }

      evidenceTabButtons.forEach((button) => {
        button.addEventListener("click", () => {
          setEvidenceTab(button.dataset.evidenceTab || "photos");
        });
      });

      if (evidenceSaveButton) {
        evidenceSaveButton.addEventListener("click", () => {
          if (!activeEvidenceId || !activeEvidenceDraft) {
            closeEvidenceModal();
            return;
          }
          normalizeEvidenceGroups(activeEvidenceDraft);
          evidenceByRow.set(activeEvidenceId, activeEvidenceDraft);
          closeEvidenceModal();
        });
      }

      if (evidenceCancelButton) {
        evidenceCancelButton.addEventListener("click", closeEvidenceModal);
      }

      if (evidenceModal) {
        evidenceModal.addEventListener("click", (event) => {
          if (event.target === evidenceModal) {
            closeEvidenceModal();
          }
        });
      }

      const userRole = document.body.dataset.userRole || "";
      if (userRole === "contratista") {
        const openEjecutadasModal = () => {
          isEjecutadasModal = true;
          openModal(
            "Actividades ejecutadas",
            "<p>Recuerda redactar este campo en primera persona.</p>",
          );
        };

        const maybeShowEjecutadasModal = (target) => {
          if (
            !target ||
            !target.matches(
              "textarea[name='obligaciones_directas_ejecutadas_item']",
            )
          ) {
            return;
          }
          activeEjecutadasField = target;
          if (target.value.trim()) {
            return;
          }
          if (suppressEjecutadasModal && activeEjecutadasField === target) {
            return;
          }
          if (statusModal.classList.contains("is-open")) {
            return;
          }
          openEjecutadasModal();
        };

        document.addEventListener("focusin", (event) => {
          maybeShowEjecutadasModal(event.target);
        });

        document.addEventListener("click", (event) => {
          maybeShowEjecutadasModal(event.target);
        });

        document.addEventListener("focusout", (event) => {
          const target = event.target;
          if (
            target &&
            target.matches(
              "textarea[name='obligaciones_directas_ejecutadas_item']",
            )
          ) {
            suppressEjecutadasModal = false;
          }
        });

        document.addEventListener("input", (event) => {
          const target = event.target;
          if (
            target &&
            target.matches(
              "textarea[name='obligaciones_directas_ejecutadas_item']",
            ) &&
            target.value.trim()
          ) {
            suppressEjecutadasModal = false;
          }
        });
      }

      const pickSaveDirectory = async () => {
        if (!window.showDirectoryPicker) {
          return null;
        }
        try {
          return await window.showDirectoryPicker({ mode: "readwrite" });
        } catch (error) {
          return null;
        }
      };

      const saveFileToDirectory = async (dirHandle, fileInfo) => {
        const res = await fetch(fileInfo.url);
        if (!res.ok) {
          throw new Error("download_failed");
        }
        const blob = await res.blob();
        const fileHandle = await dirHandle.getFileHandle(fileInfo.name, {
          create: true,
        });
        const writable = await fileHandle.createWritable();
        await writable.write(blob);
        await writable.close();
      };

      const saveGeneratedFiles = async (dirHandle, files) => {
        const items = Object.values(files || {});
        for (const info of items) {
          await saveFileToDirectory(dirHandle, info);
        }
      };

      closeModalButton.addEventListener("click", closeModal);
      statusModal.addEventListener("click", (event) => {
        if (event.target === statusModal) {
          closeModal();
        }
      });

      const activateTab = (tabId) => {
        tabs.forEach((t) => t.classList.remove("active"));
        panels.forEach((p) => p.classList.remove("active"));
        const targetTab = document.querySelector(`.tab[data-tab='${tabId}']`);
        const targetPanel = document.getElementById(tabId);
        if (targetTab) {
          targetTab.classList.add("active");
        }
        if (targetPanel) {
          targetPanel.classList.add("active");
        }
      };

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          activateTab(tab.dataset.tab);
        });
      });

      const getHistoryReviewStatus = (item) => {
        const review =
          item && item.data && typeof item.data === "object"
            ? item.data.supervisor_review
            : null;
        const status =
          review && typeof review === "object"
            ? String(review.status || "").toLowerCase()
            : "";

        if (status === "aprobado") {
          return {
            key: "aprobado",
            label: "Aprobado por supervisor",
          };
        }
        if (status === "rechazado") {
          return {
            key: "rechazado",
            label: "Requiere ajustes",
          };
        }
        return {
          key: "pendiente",
          label: "Pendiente por revisar",
        };
      };

      const renderHistory = (items) => {
        historyList.innerHTML = "";
        if (!items.length) {
          const empty = document.createElement("span");
          empty.className = "history-empty";
          empty.textContent = "Sin registros aun.";
          historyList.appendChild(empty);
          return;
        }

        items.forEach((item) => {
          const row = document.createElement("div");
          row.className = "history-row";
          const label = document.createElement("div");
          label.className = "history-title";
          const data = item.data || {};
          const info = [
            `#${item.id}`,
            data.contrato_no ? `Contrato ${data.contrato_no}` : "Contrato",
            data.contratista ? data.contratista : "",
          ]
            .filter(Boolean)
            .join(" · ");
          label.textContent = info;
          const meta = document.createElement("div");
          meta.className = "history-meta";
          meta.textContent = item.created_at;

          if (userRole === "contratista") {
            const reviewStatus = getHistoryReviewStatus(item);
            const badge = document.createElement("span");
            badge.className = `history-status-badge is-${reviewStatus.key}`;
            badge.textContent = reviewStatus.label;
            meta.appendChild(document.createTextNode(" · "));
            meta.appendChild(badge);
          }

          const actions = document.createElement("div");
          actions.className = "history-actions";
          const loadButton = document.createElement("button");
          loadButton.type = "button";
          loadButton.className = "secondary";
          loadButton.textContent = "Cargar";
          loadButton.dataset.recordId = item.id;
          const deleteButton = document.createElement("button");
          deleteButton.type = "button";
          deleteButton.className = "danger";
          deleteButton.textContent = "Eliminar";
          deleteButton.dataset.deleteId = item.id;
          actions.appendChild(loadButton);
          actions.appendChild(deleteButton);
          row.appendChild(label);
          row.appendChild(meta);
          row.appendChild(actions);
          historyList.appendChild(row);
        });
      };

      const loadHistory = async () => {
        try {
          const res = await fetch("/history");
          if (!res.ok) {
            if (res.status === 401) {
              historyList.innerHTML = "";
              const empty = document.createElement("span");
              empty.className = "history-empty";
              empty.textContent =
                "Sesion vencida o invalida. Ingresa de nuevo para ver el historial.";
              historyList.appendChild(empty);
              return;
            }
            throw new Error("history_http_error");
          }
          const json = await res.json();
          if (!json.ok) {
            throw new Error("history_api_error");
          }
          renderHistory(json.items || []);
        } catch (error) {
          historyList.innerHTML = "";
          const empty = document.createElement("span");
          empty.className = "history-empty";
          empty.textContent = "No se pudo cargar el historial.";
          historyList.appendChild(empty);
        }
      };

      const parseDdMmAaToIso = (value) => {
        if (!value) return "";
        const parts = value.split("/");
        if (parts.length !== 3) return value;
        const [day, month, yearPart] = parts;
        const year = yearPart.length === 2 ? `20${yearPart}` : yearPart;
        return `${year}-${month.padStart(2, "0")}-${day.padStart(2, "0")}`;
      };

      const setFieldValue = (name, value) => {
        const field = document.querySelector(`[name='${name}']`);
        if (!field) return;
        field.value = value ?? "";
        updateFieldState(field);
      };

      const updateFieldState = (field) => {
        const label = field.closest("label");
        const hasValue = field.value && field.value.trim();
        if (hasValue) {
          field.classList.add("is-filled");
          field.classList.remove("is-missing");
          if (label) {
            label.classList.add("is-filled");
            label.classList.remove("is-missing");
          }
        } else {
          field.classList.remove("is-filled");
          if (label) {
            label.classList.remove("is-filled");
          }
        }
      };

      const markMissing = (field, isMissing) => {
        const label = field.closest("label");
        if (isMissing) {
          field.classList.add("is-missing");
          if (label) {
            label.classList.add("is-missing");
          }
        } else {
          field.classList.remove("is-missing");
          if (label) {
            label.classList.remove("is-missing");
          }
        }
      };

      const totalField = document.querySelector("input[name='total_aportes']");
      const aporteFields = [
        "aportes_valor_salud",
        "aportes_valor_pension",
        "aportes_valor_riesgos",
      ].map((name) => document.querySelector(`input[name='${name}']`));

      const parseMoney = (value) => {
        if (!value) return 0;
        const raw = String(value).trim();
        if (!raw) return 0;
        const cleaned = raw.replace(/[^0-9,.-]+/g, "");
        if (!cleaned) return 0;
        if (cleaned.includes(",")) {
          const normalized = cleaned.replace(/\./g, "").replace(/,/g, ".");
          return Number.parseFloat(normalized) || 0;
        }
        const normalized = cleaned.replace(/\./g, "");
        return Number.parseFloat(normalized) || 0;
      };

      const formatCurrency = (value) => {
        if (value === "" || value === null || value === undefined) return "";
        const numberValue = Number(value);
        if (!Number.isFinite(numberValue)) return "";
        return new Intl.NumberFormat("es-CO", {
          style: "currency",
          currency: "COP",
          minimumFractionDigits: 0,
        }).format(numberValue);
      };

      const updateTotal = () => {
        const hasValue = aporteFields.some((field) => field.value.trim());
        const sum = aporteFields.reduce(
          (acc, field) => acc + parseMoney(field.value),
          0,
        );
        totalField.value = hasValue ? formatCurrency(sum) : "";
      };

      aporteFields.forEach((field) => {
        field.addEventListener("input", updateTotal);
        field.addEventListener("blur", () => {
          const numberValue = parseMoney(field.value);
          field.value = numberValue ? formatCurrency(numberValue) : "";
          updateTotal();
        });
      });

      const getValorActaActual = () => {
        const rows = Array.from(actasRows.querySelectorAll(".actas-row"));
        for (let index = rows.length - 1; index >= 0; index -= 1) {
          const valueInput = rows[index].querySelector(
            "input[name='acta_parcial_valor_item']",
          );
          if (valueInput && valueInput.value.trim()) {
            return parseMoney(valueInput.value);
          }
        }
        return 0;
      };

      const updateActasSubtotal = () => {
        const rows = actasRows.querySelectorAll(".actas-row");
        const hasValue = Array.from(rows).some((row) => {
          const valueInput = row.querySelector(
            "input[name='acta_parcial_valor_item']",
          );
          return valueInput && valueInput.value.trim();
        });
        const total = Array.from(rows).reduce((acc, row) => {
          const valueInput = row.querySelector(
            "input[name='acta_parcial_valor_item']",
          );
          return acc + parseMoney(valueInput.value);
        }, 0);
        actasSubtotalField.value = hasValue ? formatCurrency(total) : "";
        syncFinancierosDesdeSubtotal();
      };

      const syncFinancierosDesdeSubtotal = () => {
        const subtotal = parseMoney(actasSubtotalField?.value || "");
        const valorActaActual = getValorActaActual();
        const valorEjecutado = Math.max(0, subtotal - valorActaActual);
        if (valorACobrarField) {
          valorACobrarField.value = valorActaActual
            ? formatCurrency(valorActaActual)
            : "";
          updateFieldState(valorACobrarField);
        }
        if (valorPresenteInformeField) {
          valorPresenteInformeField.value = valorActaActual
            ? formatCurrency(valorActaActual)
            : "";
          updateFieldState(valorPresenteInformeField);
        }
        const valorEjecutadoField = document.querySelector(
          "input[name='valor_ejecutado']",
        );
        if (valorEjecutadoField) {
          valorEjecutadoField.value = subtotal
            ? formatCurrency(valorEjecutado)
            : "";
          updateFieldState(valorEjecutadoField);
        }
        if (saldoPendienteField) {
          const contrato = parseMoney(valorContratoField?.value || "");
          const saldo = contrato - subtotal;
          saldoPendienteField.value = contrato ? formatCurrency(saldo) : "";
          updateFieldState(saldoPendienteField);
        }
      };

      const syncValorContratoDesdeInicial = () => {
        if (!valorContratoField || !valorInicialField) {
          return;
        }
        const valorInicial = parseMoney(valorInicialField.value || "");
        valorContratoField.value = valorInicial
          ? formatCurrency(valorInicial)
          : "";
        updateFieldState(valorContratoField);
        syncFinancierosDesdeSubtotal();
      };

      const bindMoneyField = (field) => {
        field.addEventListener("blur", () => {
          const numberValue = parseMoney(field.value);
          if (!field.value.trim()) {
            field.value = "";
            updateFieldState(field);
            return;
          }
          field.value = formatCurrency(numberValue);
          updateFieldState(field);
        });
      };

      const shouldUppercaseField = (field) => {
        if (!field) {
          return false;
        }
        if (field.closest("#t2")) {
          return false;
        }
        if (field.classList.contains("money")) {
          return false;
        }
        if (field.tagName === "TEXTAREA") {
          return true;
        }
        if (field.tagName !== "INPUT") {
          return false;
        }
        const type = (field.type || "text").toLowerCase();
        return ["text", "search", "email", "tel"].includes(type);
      };

      const normalizeFieldToUppercase = (field) => {
        if (!shouldUppercaseField(field)) {
          return;
        }
        const value = String(field.value || "");
        const upper = value.toUpperCase();
        if (upper === value) {
          return;
        }
        const cursorStart = field.selectionStart;
        const cursorEnd = field.selectionEnd;
        field.value = upper;
        if (
          typeof cursorStart === "number" &&
          typeof cursorEnd === "number" &&
          document.activeElement === field
        ) {
          field.setSelectionRange(cursorStart, cursorEnd);
        }
      };

      const normalizeFormFieldsToUppercase = () => {
        form
          .querySelectorAll("input, textarea")
          .forEach((field) => normalizeFieldToUppercase(field));
      };

      const form = document.getElementById("form");
      const submitButton = document.querySelector("button.primary");
      const validationState = { showMissing: false };
      let formIsComplete = false;
      const plazoDia = document.querySelector("select[name='plazo_dia']");
      const plazoMes = document.querySelector("select[name='plazo_mes']");
      const plazoAnio = document.querySelector("select[name='plazo_anio']");
      const fechaExpDia = document.querySelector(
        "select[name='fecha_expedicion_informe_dia']",
      );
      const fechaExpMes = document.querySelector(
        "select[name='fecha_expedicion_informe_mes']",
      );
      const fechaExpAnio = document.querySelector(
        "select[name='fecha_expedicion_informe_año']",
      );
      const fechaInicioContratoField = document.querySelector(
        "input[name='fecha_inicio_contrato']",
      );
      const fechaVencimientoContratoField = document.querySelector(
        "input[name='fecha_vencimiento_contrato']",
      );
      const fechaPresentacionInformeField = document.querySelector(
        "input[name='fecha_presentacion_informe']",
      );
      const periodoInformadoDeField = document.querySelector(
        "input[name='periodo_i_de']",
      );
      const periodoInformadoAField = document.querySelector(
        "input[name='periodo_i_a']",
      );
      const directasRows = document.getElementById("directasRows");
      const actasRows = document.getElementById("actasRows");
      const addDirectaButton = document.getElementById("addDirecta");
      const addActaButton = document.getElementById("addActa");
      const actasSubtotalField = document.querySelector(
        "input[name='actas_subtotal']",
      );
      const supervisorSelect = document.querySelector(
        "select[name='supervisor']",
      );
      const supervisorCcField = document.querySelector(
        "input[name='supervisor_cc']",
      );
      const valorInicialField = document.querySelector(
        "input[name='valor_inicial']",
      );
      const valorContratoField = document.querySelector(
        "input[name='valor_contrato']",
      );
      const valorACobrarField = document.querySelector(
        "input[name='valor_a_cobrar']",
      );
      const valorPresenteInformeField = document.querySelector(
        "input[name='valor_presente_informe']",
      );
      const saldoPendienteField = document.querySelector(
        "input[name='saldo_pendiente']",
      );

      if (valorInicialField) {
        valorInicialField.addEventListener(
          "blur",
          syncValorContratoDesdeInicial,
        );
        valorInicialField.addEventListener(
          "change",
          syncValorContratoDesdeInicial,
        );
        valorInicialField.addEventListener(
          "input",
          syncValorContratoDesdeInicial,
        );
      }

      if (valorContratoField) {
        valorContratoField.addEventListener(
          "blur",
          syncFinancierosDesdeSubtotal,
        );
        valorContratoField.addEventListener(
          "change",
          syncFinancierosDesdeSubtotal,
        );
      }

      const autosaveKey = `draft_${tabId}`;
      const autosaveIgnoreNames = new Set([
        "obligaciones_directas_item",
        "obligaciones_directas_ejecutadas_item",
        "obligaciones_directas_aporta_evidencias_item",
        "acta_parcial_item",
        "acta_parcial_periodo_item",
        "acta_parcial_valor_item",
      ]);
      let autosaveTimer = null;

      const buildDraftData = () => {
        const data = {};
        const formData = new FormData(form);
        for (const [key, value] of formData.entries()) {
          if (autosaveIgnoreNames.has(key)) {
            continue;
          }
          data[key] = value;
        }

        const directasItems = [];
        directasRows.querySelectorAll(".activity-row").forEach((row) => {
          const actividad = row.querySelector(
            "textarea[name='obligaciones_directas_item']",
          );
          const ejecutada = row.querySelector(
            "textarea[name='obligaciones_directas_ejecutadas_item']",
          );
          const evidencias = row.querySelector(
            "select[name='obligaciones_directas_aporta_evidencias_item']",
          );
          directasItems.push({
            actividad_contrato: actividad ? actividad.value : "",
            actividad_ejecutada: ejecutada ? ejecutada.value : "",
            aporta_evidencias: evidencias ? evidencias.value : "",
          });
        });
        data.obligaciones_directas_items = directasItems;

        const actasItems = [];
        actasRows.querySelectorAll(".actas-row").forEach((row) => {
          const acta = row.querySelector("input[name='acta_parcial_item']");
          const periodo = row.querySelector(
            "input[name='acta_parcial_periodo_item']",
          );
          const valor = row.querySelector(
            "input[name='acta_parcial_valor_item']",
          );
          actasItems.push({
            acta: acta ? acta.value : "",
            periodo: periodo ? periodo.value : "",
            valor: valor ? valor.value : "",
          });
        });
        data.actas_parciales = actasItems;

        return data;
      };

      const saveDraft = () => {
        const payload = {
          data: buildDraftData(),
          activeTab: document.querySelector(".tab.active")?.dataset.tab || "t1",
        };
        localStorage.setItem(autosaveKey, JSON.stringify(payload));
      };

      const scheduleAutosave = () => {
        if (autosaveTimer) {
          window.clearTimeout(autosaveTimer);
        }
        autosaveTimer = window.setTimeout(saveDraft, 400);
      };

      const loadDraft = () => {
        const raw = localStorage.getItem(autosaveKey);
        if (!raw) {
          return null;
        }
        try {
          return JSON.parse(raw);
        } catch (error) {
          return null;
        }
      };

      const clearDraft = () => {
        localStorage.removeItem(autosaveKey);
      };

      const meses = [
        "enero",
        "febrero",
        "marzo",
        "abril",
        "mayo",
        "junio",
        "julio",
        "agosto",
        "septiembre",
        "octubre",
        "noviembre",
        "diciembre",
      ];

      const fillMeses = (selectElement) => {
        meses.forEach((mes) => {
          const option = document.createElement("option");
          option.value = mes;
          option.textContent = mes;
          selectElement.appendChild(option);
        });
      };

      const fillAnios = (selectElement) => {
        const currentYear = new Date().getFullYear();
        const startYear = currentYear - 5;
        const endYear = currentYear + 5;
        for (let year = startYear; year <= endYear; year += 1) {
          const option = document.createElement("option");
          option.value = String(year);
          option.textContent = String(year);
          selectElement.appendChild(option);
        }
      };

      const daysInMonth = (year, monthIndex) =>
        new Date(year, monthIndex + 1, 0).getDate();

      const updateDias = (daySelect, monthSelect, yearSelect) => {
        const mesIndex = meses.indexOf(monthSelect.value);
        const anio = Number(yearSelect.value);
        const currentValue = daySelect.value;

        while (daySelect.options.length > 1) {
          daySelect.remove(1);
        }

        if (mesIndex < 0 || !anio) {
          daySelect.value = "";
          return;
        }

        const totalDias = daysInMonth(anio, mesIndex);
        for (let dia = 1; dia <= totalDias; dia += 1) {
          const option = document.createElement("option");
          option.value = String(dia);
          option.textContent = String(dia);
          daySelect.appendChild(option);
        }

        if (currentValue && Number(currentValue) <= totalDias) {
          daySelect.value = currentValue;
        }
      };

      const formatIsoDate = (year, month, day) =>
        `${String(year).padStart(4, "0")}-${String(month).padStart(
          2,
          "0",
        )}-${String(day).padStart(2, "0")}`;

      const updateFechaVencimientoDesdePlazo = () => {
        if (!fechaVencimientoContratoField) {
          return;
        }
        const day = Number(plazoDia?.value || "");
        const monthName = plazoMes?.value || "";
        const year = Number(plazoAnio?.value || "");
        const monthIndex = meses.indexOf(monthName);
        if (!day || monthIndex < 0 || !year) {
          fechaVencimientoContratoField.value = "";
          updateFieldState(fechaVencimientoContratoField);
          return;
        }
        fechaVencimientoContratoField.value = formatIsoDate(
          year,
          monthIndex + 1,
          day,
        );
        updateFieldState(fechaVencimientoContratoField);
      };

      const updateFechaPresentacionDesdeExpedicion = () => {
        if (!fechaPresentacionInformeField) {
          return;
        }
        const day = Number(fechaExpDia?.value || "");
        const monthName = fechaExpMes?.value || "";
        const year = Number(fechaExpAnio?.value || "");
        const monthIndex = meses.indexOf(monthName);
        if (!day || monthIndex < 0 || !year) {
          fechaPresentacionInformeField.value = "";
          updateFieldState(fechaPresentacionInformeField);
          return;
        }
        fechaPresentacionInformeField.value = `${String(day).padStart(
          2,
          "0",
        )}/${String(monthIndex + 1).padStart(2, "0")}/${String(year).padStart(
          4,
          "0",
        )}`;
        updateFieldState(fechaPresentacionInformeField);
      };

      const formatIsoToDisplayDate = (value) => {
        if (!value) {
          return "";
        }
        const parts = String(value).split("-");
        if (parts.length !== 3) {
          return value;
        }
        const [year, month, day] = parts;
        return `${day}/${month}/${year}`;
      };

      const buildPeriodoInformadoLabel = () => {
        const from = formatIsoToDisplayDate(
          periodoInformadoDeField?.value || "",
        );
        const to = formatIsoToDisplayDate(periodoInformadoAField?.value || "");
        if (!from || !to) {
          return "";
        }
        return `${from} - ${to}`;
      };

      const syncActaPeriodoDesdeInformado = (mode = "latest-auto") => {
        const periodo = buildPeriodoInformadoLabel();
        const periodoFields = Array.from(
          actasRows.querySelectorAll("input[name='acta_parcial_periodo_item']"),
        );

        if (mode === "latest-auto") {
          for (let index = periodoFields.length - 1; index >= 0; index -= 1) {
            const field = periodoFields[index];
            if (field.dataset.autoPeriodo !== "1") {
              continue;
            }
            field.value = periodo;
            updateFieldState(field);
            return;
          }
          return;
        }

        if (mode === "empty-only") {
          periodoFields.forEach((field) => {
            const hasValue = Boolean((field.value || "").trim());
            if (!hasValue) {
              field.value = periodo;
              field.dataset.autoPeriodo = "1";
              updateFieldState(field);
            }
          });
        }
      };

      const syncSupervisorCc = (overwrite = true) => {
        if (!supervisorSelect || !supervisorCcField) {
          return;
        }
        const selectedOption =
          supervisorSelect.options[supervisorSelect.selectedIndex];
        const docNumber = selectedOption
          ? (selectedOption.dataset.docNumber || "").trim()
          : "";
        if (!overwrite && supervisorCcField.value.trim()) {
          return;
        }
        supervisorCcField.value = docNumber;
        updateFieldState(supervisorCcField);
      };

      if (supervisorSelect) {
        supervisorSelect.addEventListener("change", () => {
          syncSupervisorCc(true);
          scheduleAutosave();
          updateSubmitState();
        });
      }

      const updateSubmitState = () => {
        const requiredFields = Array.from(
          document.querySelectorAll("#form [required]"),
        );
        let allFilled = true;
        let missingCount = 0;
        const missingByTab = {};
        requiredFields.forEach((field) => {
          const hasValue = field.value.trim();
          updateFieldState(field);
          if (!hasValue) {
            allFilled = false;
            missingCount += 1;
            const panel = field.closest(".panel");
            if (panel) {
              missingByTab[panel.id] = (missingByTab[panel.id] || 0) + 1;
            }
          }
          if (validationState.showMissing) {
            markMissing(field, !hasValue);
          } else {
            markMissing(field, false);
          }
        });
        panels.forEach((panel) => {
          const tabButton = document.querySelector(
            `.tab[data-tab='${panel.id}']`,
          );
          const hasMissing = Boolean(missingByTab[panel.id]);
          if (validationState.showMissing && hasMissing) {
            panel.classList.add("has-missing");
            if (tabButton) {
              tabButton.classList.add("missing");
            }
          } else {
            panel.classList.remove("has-missing");
            if (tabButton) {
              tabButton.classList.remove("missing");
            }
          }
        });
        formIsComplete = allFilled;
        submitButton.classList.toggle("is-disabled", !allFilled);
        submitButton.setAttribute("aria-disabled", (!allFilled).toString());
        if (!allFilled && !validationState.showMissing) {
          statusEl.textContent = `Faltan ${missingCount} campos por diligenciar.`;
        }
        if (allFilled && statusEl.textContent.startsWith("Faltan")) {
          statusEl.textContent = "";
          validationState.showMissing = false;
        }
      };

      const bindFieldEvents = (field) => {
        field.addEventListener("input", () => {
          normalizeFieldToUppercase(field);
          updateSubmitState();
        });
        field.addEventListener("change", () => {
          normalizeFieldToUppercase(field);
          updateSubmitState();
        });
        field.addEventListener("blur", () => updateFieldState(field));
        field.addEventListener("input", scheduleAutosave);
        field.addEventListener("change", scheduleAutosave);
      };

      Array.from(document.querySelectorAll("#form [required]")).forEach(
        (field) => {
          bindFieldEvents(field);
        },
      );

      Array.from(document.querySelectorAll(".money")).forEach((field) => {
        bindMoneyField(field);
      });

      const updateRemoveButtons = (container) => {
        const rows = container.querySelectorAll(".activity-row");
        rows.forEach((row) => {
          const removeButton = row.querySelector(".icon-button");
          if (removeButton) {
            removeButton.disabled = rows.length <= 1;
          }
        });
      };

      const createActivityRow = (
        container,
        nameBase,
        includeEvidencias,
        values = {},
      ) => {
        const row = document.createElement("div");
        row.className = "activity-row";
        row.dataset.evidenceId = createEvidenceId();

        const actividad = document.createElement("textarea");
        actividad.name = `${nameBase}_item`;
        actividad.required = true;
        actividad.value = values.actividad_contrato || "";

        const ejecutada = document.createElement("textarea");
        ejecutada.name = `${nameBase}_ejecutadas_item`;
        ejecutada.required = true;
        ejecutada.value = values.actividad_ejecutada || "";

        let evidencias = null;
        if (includeEvidencias) {
          evidencias = document.createElement("select");
          evidencias.name = `${nameBase}_aporta_evidencias_item`;
          evidencias.required = true;

          const defaultOption = document.createElement("option");
          defaultOption.value = "";
          defaultOption.textContent = "Selecciona";
          evidencias.appendChild(defaultOption);

          const optionSi = document.createElement("option");
          optionSi.value = "SI";
          optionSi.textContent = "SI";
          evidencias.appendChild(optionSi);

          const optionNo = document.createElement("option");
          optionNo.value = "NO";
          optionNo.textContent = "NO";
          evidencias.appendChild(optionNo);
          evidencias.value = values.aporta_evidencias || "";
          if (userRole === "contratista") {
            evidencias.addEventListener("change", (event) => {
              if (event.target.value === "SI") {
                openEvidenceModal(row);
              }
            });
          }
        }

        const removeButton = document.createElement("button");
        removeButton.type = "button";
        removeButton.className = "icon-button";
        removeButton.title = "Eliminar";
        removeButton.textContent = "Eliminar";
        removeButton.addEventListener("click", () => {
          evidenceByRow.delete(row.dataset.evidenceId);
          row.remove();
          updateRemoveButtons(container);
          updateSubmitState();
        });

        row.appendChild(actividad);
        row.appendChild(ejecutada);
        if (evidencias) {
          row.appendChild(evidencias);
        }
        row.appendChild(removeButton);
        container.appendChild(row);

        bindFieldEvents(actividad);
        bindFieldEvents(ejecutada);
        if (evidencias) {
          bindFieldEvents(evidencias);
        }

        updateFieldState(actividad);
        updateFieldState(ejecutada);
        if (evidencias) {
          updateFieldState(evidencias);
        }

        updateRemoveButtons(container);

        if (values.evidencias) {
          evidenceByRow.set(
            row.dataset.evidenceId,
            cloneEvidence(values.evidencias),
          );
        }
      };

      const updateActaRemoveButtons = () => {
        const rows = actasRows.querySelectorAll(".actas-row");
        rows.forEach((row) => {
          const removeButton = row.querySelector(".icon-button");
          if (removeButton) {
            removeButton.disabled = rows.length <= 1;
          }
        });
      };

      const createActaRow = (values = {}) => {
        const row = document.createElement("div");
        row.className = "actas-row";

        const acta = document.createElement("input");
        acta.name = "acta_parcial_item";
        acta.required = true;
        acta.value = values.acta || "";

        const periodo = document.createElement("input");
        periodo.name = "acta_parcial_periodo_item";
        periodo.required = true;
        periodo.value = values.periodo || "";
        periodo.dataset.autoPeriodo = values.periodo ? "0" : "1";
        periodo.addEventListener("input", () => {
          periodo.dataset.autoPeriodo = "0";
        });
        periodo.addEventListener("change", () => {
          periodo.dataset.autoPeriodo = "0";
        });

        const valor = document.createElement("input");
        valor.name = "acta_parcial_valor_item";
        valor.required = true;
        valor.className = "money";
        valor.value = values.valor || "";
        valor.addEventListener("input", updateActasSubtotal);
        bindMoneyField(valor);

        const removeButton = document.createElement("button");
        removeButton.type = "button";
        removeButton.className = "icon-button";
        removeButton.title = "Eliminar";
        removeButton.textContent = "Eliminar";
        removeButton.addEventListener("click", () => {
          row.remove();
          updateActaRemoveButtons();
          updateActasSubtotal();
          updateSubmitState();
        });

        row.appendChild(acta);
        row.appendChild(periodo);
        row.appendChild(valor);
        row.appendChild(removeButton);
        actasRows.appendChild(row);

        bindFieldEvents(acta);
        bindFieldEvents(periodo);
        bindFieldEvents(valor);

        updateFieldState(acta);
        updateFieldState(periodo);
        updateFieldState(valor);

        updateActaRemoveButtons();
        syncActaPeriodoDesdeInformado("latest-auto");
      };

      addDirectaButton.addEventListener("click", () => {
        createActivityRow(directasRows, "obligaciones_directas", true);
        updateSubmitState();
        scheduleAutosave();
      });

      addActaButton.addEventListener("click", () => {
        createActaRow();
        updateSubmitState();
        scheduleAutosave();
      });

      const bindInitialRemoveButtons = (container) => {
        container.querySelectorAll(".icon-button").forEach((button) => {
          button.addEventListener("click", (event) => {
            const row = event.target.closest(".activity-row");
            if (!row) return;
            evidenceByRow.delete(row.dataset.evidenceId);
            row.remove();
            updateRemoveButtons(container);
            updateSubmitState();
            scheduleAutosave();
          });
        });
      };

      const initEvidenceRows = () => {
        directasRows.querySelectorAll(".activity-row").forEach((row) => {
          if (!row.dataset.evidenceId) {
            row.dataset.evidenceId = createEvidenceId();
          }
          const evidenciasField = row.querySelector(
            "select[name='obligaciones_directas_aporta_evidencias_item']",
          );
          if (evidenciasField && userRole === "contratista") {
            evidenciasField.addEventListener("change", (event) => {
              if (event.target.value === "SI") {
                openEvidenceModal(row);
              }
            });
          }
        });
      };

      bindInitialRemoveButtons(directasRows);
      initEvidenceRows();
      actasRows.querySelectorAll(".icon-button").forEach((button) => {
        button.addEventListener("click", (event) => {
          const row = event.target.closest(".actas-row");
          if (!row) return;
          row.remove();
          updateActaRemoveButtons();
          updateActasSubtotal();
          updateSubmitState();
          scheduleAutosave();
        });
      });

      actasRows
        .querySelectorAll("input[name='acta_parcial_valor_item']")
        .forEach((field) => {
          field.addEventListener("input", updateActasSubtotal);
          bindMoneyField(field);
        });

      actasRows
        .querySelectorAll("input[name='acta_parcial_periodo_item']")
        .forEach((field) => {
          field.dataset.autoPeriodo = field.value.trim() ? "0" : "1";
          field.addEventListener("input", () => {
            field.dataset.autoPeriodo = "0";
          });
          field.addEventListener("change", () => {
            field.dataset.autoPeriodo = "0";
          });
        });

      fillMeses(plazoMes);
      fillMeses(fechaExpMes);
      fillAnios(plazoAnio);
      fillAnios(fechaExpAnio);
      syncSupervisorCc(false);
      updateDias(plazoDia, plazoMes, plazoAnio);
      updateDias(fechaExpDia, fechaExpMes, fechaExpAnio);
      plazoMes.addEventListener("change", () =>
        updateDias(plazoDia, plazoMes, plazoAnio),
      );
      plazoAnio.addEventListener("change", () =>
        updateDias(plazoDia, plazoMes, plazoAnio),
      );
      fechaExpMes.addEventListener("change", () =>
        updateDias(fechaExpDia, fechaExpMes, fechaExpAnio),
      );
      fechaExpAnio.addEventListener("change", () =>
        updateDias(fechaExpDia, fechaExpMes, fechaExpAnio),
      );

      [plazoDia, plazoMes, plazoAnio].forEach((field) => {
        if (!field) {
          return;
        }
        field.addEventListener("change", updateFechaVencimientoDesdePlazo);
        field.addEventListener("input", updateFechaVencimientoDesdePlazo);
      });

      [fechaExpDia, fechaExpMes, fechaExpAnio].forEach((field) => {
        if (!field) {
          return;
        }
        field.addEventListener(
          "change",
          updateFechaPresentacionDesdeExpedicion,
        );
        field.addEventListener("input", updateFechaPresentacionDesdeExpedicion);
      });

      [periodoInformadoDeField, periodoInformadoAField].forEach((field) => {
        if (!field) {
          return;
        }
        field.addEventListener("change", () =>
          syncActaPeriodoDesdeInformado("latest-auto"),
        );
        field.addEventListener("input", () =>
          syncActaPeriodoDesdeInformado("latest-auto"),
        );
      });

      if (fechaInicioContratoField) {
        fechaInicioContratoField.addEventListener(
          "change",
          updateFechaVencimientoDesdePlazo,
        );
      }

      updateFechaVencimientoDesdePlazo();
      updateFechaPresentacionDesdeExpedicion();
      syncValorContratoDesdeInicial();
      syncActaPeriodoDesdeInformado("empty-only");
      normalizeFormFieldsToUppercase();

      updateRemoveButtons(directasRows);
      updateActaRemoveButtons();
      updateActasSubtotal();
      syncFinancierosDesdeSubtotal();
      updateSubmitState();

      submitButton.addEventListener("click", (event) => {
        if (formIsComplete) {
          return;
        }
        event.preventDefault();
        validationState.showMissing = true;
        updateSubmitState();
        const missingFields = Array.from(
          document.querySelectorAll("#form [required].is-missing"),
        );
        const missingLabels = missingFields
          .map((field) => {
            const label = field.closest("label");
            return label ? label.textContent.trim() : field.name;
          })
          .filter(Boolean);
        const listItems = missingLabels
          .map((text) => `<li>${text}</li>`)
          .join("");
        openModal(
          "Faltan campos",
          `<p>Completa los siguientes campos:</p><ul>${listItems}</ul>`,
        );
        const firstMissing = document.querySelector(
          "#form [required].is-missing",
        );
        if (firstMissing) {
          const panel = firstMissing.closest(".panel");
          if (panel) {
            activateTab(panel.id);
            panel.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        }
      });

      const setActivityRows = (
        container,
        nameBase,
        includeEvidencias,
        items,
      ) => {
        container.innerHTML = "";
        if (!items || !items.length) {
          createActivityRow(container, nameBase, includeEvidencias);
          return;
        }
        items.forEach((item) =>
          createActivityRow(container, nameBase, includeEvidencias, item),
        );
      };

      const setActaRows = (items) => {
        actasRows.innerHTML = "";
        if (!items || !items.length) {
          createActaRow();
          return;
        }
        items.forEach((item) => createActaRow(item));
      };

      const applyHistoryData = (data) => {
        if (!data) return;
        evidenceByRow.clear();
        Object.keys(data).forEach((key) => {
          if (
            [
              "obligaciones_directas_items",
              "obligaciones_generales_items",
              "actas_parciales",
              "actas_subtotal",
            ].includes(key)
          ) {
            return;
          }
          setFieldValue(key, data[key]);
        });

        if (!data.supervisor_cc) {
          syncSupervisorCc(false);
        }

        [
          "fecha_contrato",
          "fecha_inicio_contrato",
          "fecha_vencimiento_contrato",
          "periodo_i_de",
          "periodo_i_a",
          "fecha_pago_aportes",
        ].forEach((name) => {
          const raw = data[name];
          if (!raw) return;
          setFieldValue(name, parseDdMmAaToIso(raw));
        });

        setFieldValue(
          "fecha_expedicion_informe_año",
          data.fecha_expedicion_informe_año || "",
        );
        setFieldValue(
          "fecha_expedicion_informe_mes",
          data.fecha_expedicion_informe_mes || "",
        );
        updateDias(fechaExpDia, fechaExpMes, fechaExpAnio);
        setFieldValue(
          "fecha_expedicion_informe_dia",
          data.fecha_expedicion_informe_dia || "",
        );

        setFieldValue("plazo_anio", data.plazo_anio || "");
        setFieldValue("plazo_mes", data.plazo_mes || "");
        updateDias(plazoDia, plazoMes, plazoAnio);
        setFieldValue("plazo_dia", data.plazo_dia || "");

        setActivityRows(
          directasRows,
          "obligaciones_directas",
          true,
          data.obligaciones_directas_items || [],
        );
        setActaRows(data.actas_parciales || []);
        updateRemoveButtons(directasRows);
        updateActaRemoveButtons();
        updateActasSubtotal();
        syncValorContratoDesdeInicial();
        syncFinancierosDesdeSubtotal();
        syncActaPeriodoDesdeInformado("latest-auto");
        normalizeFormFieldsToUppercase();
        updateSubmitState();
        scheduleAutosave();
      };

      const draftPayload = loadDraft();
      if (draftPayload && draftPayload.data) {
        applyHistoryData(draftPayload.data);
        if (draftPayload.activeTab) {
          activateTab(draftPayload.activeTab);
        }
      }

      historyList.addEventListener("click", async (event) => {
        const target = event.target;
        if (
          target.matches("button[data-record-id]") ||
          target.dataset.recordId
        ) {
          const recordId = target.dataset.recordId;
          if (!recordId) return;
          try {
            const res = await fetch(`/history/${recordId}`);
            if (!res.ok) {
              if (res.status === 401) {
                statusEl.textContent =
                  "Sesion vencida o invalida. Ingresa de nuevo.";
                return;
              }
              throw new Error("history_item_http_error");
            }
            const json = await res.json();
            if (json.ok) {
              applyHistoryData(json.item.data);
              window.scrollTo({ top: 0, behavior: "smooth" });
            } else {
              statusEl.textContent = "No se pudo cargar el registro";
            }
          } catch (error) {
            statusEl.textContent = "No se pudo cargar el registro";
          }
          return;
        }

        if (
          target.matches("button[data-delete-id]") ||
          target.dataset.deleteId
        ) {
          const recordId = target.dataset.deleteId;
          if (!recordId) return;
          if (!window.confirm("Eliminar este registro del historial?")) {
            return;
          }
          try {
            const res = await fetch(`/history/${recordId}/delete`, {
              method: "POST",
            });
            const json = await res.json();
            if (json.ok) {
              loadHistory();
              statusEl.textContent = "Registro eliminado";
            } else {
              statusEl.textContent = "No se pudo eliminar el registro";
            }
          } catch (error) {
            statusEl.textContent = "No se pudo eliminar el registro";
          }
        }
      });

      const formatDateToDdMmAa = (value) => {
        if (!value) return "";
        const parts = value.split("-");
        if (parts.length !== 3) return value;
        const [year, month, day] = parts;
        return `${day}/${month}/${year.slice(-2)}`;
      };

      const dateFieldNames = [
        "fecha_contrato",
        "fecha_inicio_contrato",
        "fecha_vencimiento_contrato",
        "periodo_i_de",
        "periodo_i_a",
        "fecha_pago_aportes",
      ];

      document.getElementById("form").addEventListener("submit", async (e) => {
        e.preventDefault();
        normalizeFormFieldsToUppercase();
        if (!formIsComplete) {
          validationState.showMissing = true;
          updateSubmitState();
          return;
        }
        const missingEvidence = [];
        directasRows.querySelectorAll(".activity-row").forEach((row, index) => {
          const evidenciasField = row.querySelector(
            "select[name='obligaciones_directas_aporta_evidencias_item']",
          );
          if (!evidenciasField || evidenciasField.value !== "SI") {
            return;
          }
          const evidenceId = row.dataset.evidenceId;
          const evidence = evidenceId ? evidenceByRow.get(evidenceId) : null;
          const imageCount =
            evidence && Array.isArray(evidence.images)
              ? evidence.images.length
              : 0;
          const pdfCount =
            evidence && Array.isArray(evidence.pdfs) ? evidence.pdfs.length : 0;
          if (!evidence || imageCount + pdfCount === 0) {
            missingEvidence.push(index + 1);
          }
        });
        if (missingEvidence.length) {
          const items = missingEvidence
            .map((pos) => `<li>Actividad ${pos}</li>`)
            .join("");
          openModal(
            "Faltan evidencias",
            `<p>Debes adjuntar al menos una evidencia (foto o PDF) para:</p><ul>${items}</ul>`,
          );
          return;
        }
        const saveDirHandle = await pickSaveDirectory();
        syncSupervisorCc(true);
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        dateFieldNames.forEach((name) => {
          data[name] = formatDateToDdMmAa(data[name]);
        });
        const actas = [];
        actasRows.querySelectorAll(".actas-row").forEach((row) => {
          const acta = row
            .querySelector("input[name='acta_parcial_item']")
            .value.trim();
          const periodo = row
            .querySelector("input[name='acta_parcial_periodo_item']")
            .value.trim();
          const valorRaw = row
            .querySelector("input[name='acta_parcial_valor_item']")
            .value.trim();

          if (!acta && !periodo && !valorRaw) {
            return;
          }

          const valorNum = parseMoney(valorRaw);
          actas.push({
            acta,
            periodo,
            valor: valorRaw,
            valor_num: valorNum,
          });
        });

        const actasSubtotalNum = actas.reduce(
          (acc, item) => acc + (item.valor_num || 0),
          0,
        );
        data.actas_parciales = actas;
        data.actas_subtotal = actasSubtotalNum
          ? formatCurrency(actasSubtotalNum)
          : "";
        const collectRows = (container, nameBase) => {
          const items = [];
          const actividadText = [];
          const ejecutadaText = [];
          container.querySelectorAll(".activity-row").forEach((row) => {
            const actividad = row
              .querySelector(`textarea[name='${nameBase}_item']`)
              .value.trim();
            const ejecutada = row
              .querySelector(`textarea[name='${nameBase}_ejecutadas_item']`)
              .value.trim();
            const evidenciasField = row.querySelector(
              `select[name='${nameBase}_aporta_evidencias_item']`,
            );
            const evidencias = evidenciasField
              ? evidenciasField.value.trim()
              : "";

            if (!actividad && !ejecutada && !evidencias) {
              return;
            }

            const item = {
              actividad_contrato: actividad,
              actividad_ejecutada: ejecutada,
            };
            if (evidenciasField) {
              item.aporta_evidencias = evidencias;
              if (evidencias === "SI") {
                const evidenceId = row.dataset.evidenceId;
                const evidence = evidenceId
                  ? evidenceByRow.get(evidenceId)
                  : null;
                if (evidence) {
                  item.evidencias = evidence;
                }
              }
            }
            items.push(item);
            actividadText.push(actividad);
            ejecutadaText.push(ejecutada);
          });

          return {
            items,
            actividadText: actividadText.join("\n"),
            ejecutadaText: ejecutadaText.join("\n"),
          };
        };

        const directasData = collectRows(directasRows, "obligaciones_directas");
        data.obligaciones_directas_items = directasData.items;
        data.obligaciones_directas = directasData.actividadText;
        data.obligaciones_directas_ejecutadas = directasData.ejecutadaText;
        data.obligaciones_generales_items = [];
        data.obligaciones_generales = "";
        data.obligaciones_generales_ejecutadas = "";
        statusEl.textContent = "Generando...";

        const res = await fetch("/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        const json = await res.json();
        statusEl.textContent = json.ok ? "Listo" : "Error";
        if (json.ok) {
          validationState.showMissing = false;
          updateSubmitState();
          loadHistory();
          clearDraft();
          let detailMessage =
            "<p>Los documentos se generaron correctamente.</p>";
          const fileNames = Object.values(json.files || {})
            .map((item) => item.name)
            .filter(Boolean);
          if (fileNames.length) {
            detailMessage += "<p><strong>Archivos:</strong></p>";
            detailMessage +=
              "<ul>" +
              fileNames.map((name) => `<li>${escapeHtml(name)}</li>`).join("") +
              "</ul>";
          }
          if (outputDir) {
            detailMessage += `<p><strong>Ruta:</strong> ${escapeHtml(outputDir)}</p>`;
          }
          if (saveDirHandle) {
            statusEl.textContent = "Guardando archivos...";
            try {
              await saveGeneratedFiles(saveDirHandle, json.files);
              detailMessage =
                "<p>Los documentos se generaron y se guardaron en la carpeta seleccionada.</p>";
            } catch (error) {
              detailMessage =
                "<p>Los documentos se generaron, pero no se pudieron guardar en la carpeta seleccionada.</p>";
            }
          } else if (!window.showDirectoryPicker) {
            detailMessage =
              "<p>Los documentos se generaron. Tu navegador no permite elegir carpeta; revisa la carpeta output.</p>";
          } else {
            detailMessage =
              "<p>Los documentos se generaron. No seleccionaste carpeta; revisa la carpeta output.</p>";
          }
          openModal("Informes generados con exito", detailMessage);
        }
      });

      refreshHistoryButton.addEventListener("click", loadHistory);
      loadHistory();
    </script>
    <script>
      // SUPERVISOR REVIEW LOGIC (JS)
      if (userRole === "supervisor") {
        const supervisorReportsMenu = document.getElementById(
          "supervisor-reports-menu",
        );
        const supervisorReviewPanel = document.getElementById(
          "supervisor-review-panel",
        );
        const supervisorEmptyState = document.getElementById(
          "supervisor-empty-state",
        );
        const supervisorActivitiesList = document.getElementById(
          "supervisor-activities-list",
        );
        const supervisorHistoryList = document.getElementById(
          "supervisor-history-list",
        );
        const supervisorNotification = document.getElementById(
          "supervisor-notification",
        );
        const supervisorGlobalObservation = document.getElementById(
          "supervisor-global-observation",
        );
        const approveButton = document.getElementById(
          "supervisor-approve-report",
        );
        const rejectButton = document.getElementById(
          "supervisor-reject-report",
        );
        const draftButton = document.getElementById("supervisor-save-draft");
        const filterContractor = document.getElementById("filter-contractor");
        const filterPeriod = document.getElementById("filter-period");
        const filterStatus = document.getElementById("filter-status");
        const supervisorRefreshButton = document.getElementById(
          "supervisor-refresh-btn",
        );
        const supervisorLastSync = document.getElementById(
          "supervisor-last-sync",
        );
        const supervisorSideLinks = Array.from(
          document.querySelectorAll(".supervisor-side-link"),
        );
        const supervisorStatTotal = document.getElementById(
          "supervisor-stat-total",
        );
        const supervisorStatPending = document.getElementById(
          "supervisor-stat-pending",
        );
        const supervisorStatApproved = document.getElementById(
          "supervisor-stat-approved",
        );
        const supervisorStatRejected = document.getElementById(
          "supervisor-stat-rejected",
        );
        const supervisorSelectedTitle = document.getElementById(
          "supervisor-selected-title",
        );
        const supervisorSelectedMeta = document.getElementById(
          "supervisor-selected-meta",
        );
        const supervisorDetailContractor = document.getElementById(
          "supervisor-detail-contractor",
        );
        const supervisorDetailContract = document.getElementById(
          "supervisor-detail-contract",
        );
        const supervisorDetailObject = document.getElementById(
          "supervisor-detail-object",
        );
        let currentSupervisorReportId = null;
        let supervisorReportsCache = [];

        function normalizeReviewStatus(status) {
          if (status === "aprobado" || status === "rechazado") {
            return status;
          }
          return "pendiente";
        }

        function updateSupervisorStats(reports) {
          if (
            !supervisorStatTotal ||
            !supervisorStatPending ||
            !supervisorStatApproved ||
            !supervisorStatRejected
          ) {
            return;
          }
          const total = reports.length;
          const pending = reports.filter(
            (item) => normalizeReviewStatus(item.status) === "pendiente",
          ).length;
          const approved = reports.filter(
            (item) => normalizeReviewStatus(item.status) === "aprobado",
          ).length;
          const rejected = reports.filter(
            (item) => normalizeReviewStatus(item.status) === "rechazado",
          ).length;

          supervisorStatTotal.textContent = String(total);
          supervisorStatPending.textContent = String(pending);
          supervisorStatApproved.textContent = String(approved);
          supervisorStatRejected.textContent = String(rejected);
        }

        function syncSupervisorSideLinks() {
          supervisorSideLinks.forEach((button) => {
            button.classList.toggle(
              "is-active",
              (button.dataset.status || "") === (filterStatus.value || ""),
            );
          });
        }

        function updateSupervisorSelectedSummary(reportId) {
          if (!supervisorSelectedTitle || !supervisorSelectedMeta) {
            return;
          }
          const selected = supervisorReportsCache.find(
            (item) => Number(item.id) === Number(reportId),
          );
          if (!selected) {
            supervisorSelectedTitle.textContent = "Informe";
            supervisorSelectedMeta.textContent =
              "Selecciona un informe para ver sus datos.";
            return;
          }
          supervisorSelectedTitle.textContent =
            selected.contractor || "Sin contratista";
          supervisorSelectedMeta.textContent = `Periodo: ${
            selected.period || "Sin periodo"
          } · Estado: ${capitalize(normalizeReviewStatus(selected.status))}`;

          if (supervisorDetailContractor) {
            supervisorDetailContractor.textContent =
              selected.contractor || "Sin contratista";
          }
          if (supervisorDetailContract) {
            supervisorDetailContract.textContent = "Sin número";
          }
          if (supervisorDetailObject) {
            supervisorDetailObject.textContent = "Sin información registrada.";
          }
        }

        function renderSupervisorDetailSummary(detail) {
          const summary =
            detail && typeof detail.summary === "object" ? detail.summary : {};
          const contractor = summary.contratista || "Sin contratista";
          const contractNo = summary.contrato_no || "Sin número";
          const objectText =
            summary.objeto_contractual || "Sin información registrada.";
          const period = summary.periodo || "Sin periodo";
          const status = capitalize(normalizeReviewStatus(detail.status || ""));

          if (supervisorSelectedTitle) {
            supervisorSelectedTitle.textContent = contractor;
          }
          if (supervisorSelectedMeta) {
            supervisorSelectedMeta.textContent = `Contrato ${contractNo} · Periodo ${period} · Estado: ${status || "Pendiente"}`;
          }
          if (supervisorDetailContractor) {
            supervisorDetailContractor.textContent = contractor;
          }
          if (supervisorDetailContract) {
            supervisorDetailContract.textContent = contractNo;
          }
          if (supervisorDetailObject) {
            supervisorDetailObject.textContent = objectText;
          }
        }

        function updateSupervisorLastSync() {
          if (!supervisorLastSync) {
            return;
          }
          const now = new Date();
          supervisorLastSync.textContent = `Sincronizado ${now.toLocaleTimeString(
            "es-CO",
            {
              hour: "2-digit",
              minute: "2-digit",
            },
          )}`;
        }

        function updateSupervisorActiveItem() {
          if (!supervisorReportsMenu) {
            return;
          }
          supervisorReportsMenu
            .querySelectorAll(".supervisor-report-item")
            .forEach((item) => {
              const button = item.querySelector(".supervisor-open-review");
              const reportId = Number(
                (button && button.dataset.reportId) || "0",
              );
              item.classList.toggle(
                "is-active",
                reportId === currentSupervisorReportId,
              );
            });
        }

        function capitalize(str) {
          if (!str) return "";
          return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function setSupervisorNotification(message, isError = false) {
          if (!supervisorNotification) {
            return;
          }
          const span = supervisorNotification.querySelector("span");
          if (span) {
            span.textContent = message;
          } else {
            supervisorNotification.textContent = message;
          }
          supervisorNotification.style.display = "";
          supervisorNotification.style.borderColor = isError
            ? "#e3b1b1"
            : "#b9d9cd";
          supervisorNotification.style.background = isError
            ? "#fff1f1"
            : "#e9f6f1";
          supervisorNotification.style.color = isError ? "#9a2c2c" : "#0f6c5f";
        }

        function clearSupervisorNotification() {
          if (supervisorNotification) {
            supervisorNotification.style.display = "none";
          }
        }

        async function fetchSupervisorReports() {
          try {
            const res = await fetch("/api/supervisor/reports");
            if (!res.ok) {
              return [];
            }
            const json = await res.json();
            return json.ok ? json.reports || [] : [];
          } catch (error) {
            return [];
          }
        }

        async function fetchSupervisorReportDetail(reportId) {
          try {
            const res = await fetch(`/api/supervisor/report/${reportId}`);
            if (!res.ok) {
              return null;
            }
            const json = await res.json();
            return json.ok ? json : null;
          } catch (error) {
            return null;
          }
        }

        async function sendSupervisorReview(reportId, payload) {
          try {
            const res = await fetch(
              `/api/supervisor/report/${reportId}/review`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              },
            );
            const json = await res.json();
            return { ok: Boolean(json.ok), error: json.error || null };
          } catch (error) {
            return { ok: false, error: "network_error" };
          }
        }

        function renderSupervisorActivities(activities) {
          supervisorActivitiesList.innerHTML = "";
          if (!Array.isArray(activities) || !activities.length) {
            const empty = document.createElement("div");
            empty.className = "history-empty";
            empty.textContent = "No hay actividades para revisar.";
            supervisorActivitiesList.appendChild(empty);
            return;
          }

          for (const act of activities) {
            const row = document.createElement("article");
            row.className = "supervisor-activity-row";
            row.dataset.activityId = String(act.id || "");

            const content = document.createElement("div");
            content.className = "supervisor-activity-content";

            const contractSection = document.createElement("section");
            contractSection.className = "supervisor-activity-section";
            const contractTitle = document.createElement("h5");
            contractTitle.textContent = "Actividad del contrato";
            const contractText = document.createElement("p");
            contractText.textContent =
              act.contract_activity || act.desc || "Sin información";
            contractSection.appendChild(contractTitle);
            contractSection.appendChild(contractText);

            const executedSection = document.createElement("section");
            executedSection.className = "supervisor-activity-section";
            const executedTitle = document.createElement("h5");
            executedTitle.textContent = "Actividad ejecutada";
            const executedText = document.createElement("p");
            executedText.textContent =
              act.executed_activity || "Sin actividad ejecutada registrada.";
            executedSection.appendChild(executedTitle);
            executedSection.appendChild(executedText);

            content.appendChild(contractSection);
            content.appendChild(executedSection);

            const evidenceSection = document.createElement("section");
            evidenceSection.className = "supervisor-evidence-section";
            const evidenceTitle = document.createElement("h5");
            evidenceTitle.textContent = "Evidencia fotográfica";
            evidenceSection.appendChild(evidenceTitle);

            const groups = Array.isArray(act.evidence_groups)
              ? act.evidence_groups
              : [];
            if (!groups.length) {
              const emptyEvidence = document.createElement("p");
              emptyEvidence.className = "supervisor-evidence-empty";
              emptyEvidence.textContent =
                "Sin evidencias fotográficas registradas.";
              evidenceSection.appendChild(emptyEvidence);
            } else {
              const groupsWrap = document.createElement("div");
              groupsWrap.className = "supervisor-evidence-groups";

              groups.forEach((group, groupIndex) => {
                const groupCard = document.createElement("div");
                groupCard.className = "supervisor-evidence-group";

                const groupMeta = document.createElement("div");
                groupMeta.className = "supervisor-evidence-meta";

                const groupLabel = document.createElement("strong");
                groupLabel.textContent = `Grupo ${groupIndex + 1}`;
                groupMeta.appendChild(groupLabel);

                if (group && group.date) {
                  const groupDate = document.createElement("span");
                  groupDate.textContent = `Fecha: ${group.date}`;
                  groupMeta.appendChild(groupDate);
                }

                if (group && group.description) {
                  const groupDesc = document.createElement("p");
                  groupDesc.textContent = group.description;
                  groupMeta.appendChild(groupDesc);
                }

                groupCard.appendChild(groupMeta);

                const photos = Array.isArray(group && group.photos)
                  ? group.photos
                  : [];
                if (photos.length) {
                  const photosGrid = document.createElement("div");
                  photosGrid.className = "supervisor-evidence-photos";
                  photos.forEach((photo) => {
                    if (!photo || !photo.url) {
                      return;
                    }
                    const image = document.createElement("img");
                    image.src = photo.url;
                    image.alt = photo.name || "Evidencia";
                    photosGrid.appendChild(image);
                  });
                  groupCard.appendChild(photosGrid);
                }

                groupsWrap.appendChild(groupCard);
              });

              evidenceSection.appendChild(groupsWrap);
            }

            const select = document.createElement("select");
            select.className = "supervisor-activity-status";
            select.dataset.actId = String(act.id || "");

            ["cumplida", "no cumplida", "pendiente"].forEach((status) => {
              const option = document.createElement("option");
              option.value = status;
              option.textContent = capitalize(status);
              if (act.status === status) {
                option.selected = true;
              }
              select.appendChild(option);
            });

            const normalizedStatus = String(act.status || "")
              .trim()
              .toLowerCase();
            if (normalizedStatus !== "cumplida") {
              row.classList.add("is-not-completed");
            }
            select.addEventListener("change", () => {
              const nextStatus = String(select.value || "")
                .trim()
                .toLowerCase();
              row.classList.toggle(
                "is-not-completed",
                nextStatus !== "cumplida",
              );
              if (nextStatus === "cumplida") {
                row.classList.remove("is-approval-warning");
              }
            });

            const obs = document.createElement("input");
            obs.type = "text";
            obs.className = "supervisor-activity-obs";
            obs.dataset.actId = String(act.id || "");
            obs.placeholder = "Observación";
            obs.value = act.obs || "";

            const controls = document.createElement("div");
            controls.className = "supervisor-review-controls";
            controls.appendChild(select);
            controls.appendChild(obs);

            row.appendChild(content);
            row.appendChild(evidenceSection);
            row.appendChild(controls);
            supervisorActivitiesList.appendChild(row);
          }
        }

        function renderSupervisorHistory(history) {
          supervisorHistoryList.innerHTML = "";
          if (!Array.isArray(history) || !history.length) {
            const li = document.createElement("li");
            li.textContent = "Sin historial de revisiones.";
            supervisorHistoryList.appendChild(li);
            return;
          }
          for (const h of history) {
            const li = document.createElement("li");
            li.textContent = `${h.date}: ${h.action} por ${h.by}`;
            supervisorHistoryList.appendChild(li);
          }
        }

        async function openSupervisorReviewPanel(reportId) {
          currentSupervisorReportId = reportId;
          supervisorReviewPanel.style.display = "";
          if (supervisorEmptyState) {
            supervisorEmptyState.style.display = "none";
          }
          updateSupervisorSelectedSummary(reportId);
          updateSupervisorActiveItem();
          clearSupervisorNotification();

          const detail = await fetchSupervisorReportDetail(reportId);
          if (!detail) {
            setSupervisorNotification(
              "No se pudo cargar el detalle del informe.",
              true,
            );
            supervisorActivitiesList.innerHTML = "";
            supervisorHistoryList.innerHTML = "";
            return;
          }

          renderSupervisorActivities(detail.actividades || []);
          renderSupervisorDetailSummary(detail);
          renderSupervisorHistory(detail.history || []);
          supervisorGlobalObservation.value = detail.observacion_global || "";
        }

        function collectSupervisorActivities() {
          return Array.from(
            document.querySelectorAll(".supervisor-activity-row"),
          ).map((row) => {
            const statusField = row.querySelector(
              ".supervisor-activity-status",
            );
            const obsField = row.querySelector(".supervisor-activity-obs");
            return {
              id: statusField ? statusField.dataset.actId : "",
              status: statusField ? statusField.value : "pendiente",
              obs: obsField ? obsField.value : "",
            };
          });
        }

        function getPendingActivitiesForApproval(activities) {
          if (!Array.isArray(activities)) {
            return [];
          }
          return activities.filter((activity) => {
            const activityStatus = String(
              activity && activity.status ? activity.status : "",
            )
              .trim()
              .toLowerCase();
            return activityStatus !== "cumplida";
          });
        }

        function clearSupervisorApprovalHighlights() {
          document
            .querySelectorAll(".supervisor-activity-row.is-approval-warning")
            .forEach((row) => row.classList.remove("is-approval-warning"));
        }

        function highlightPendingActivitiesForApproval(pendingActivities) {
          clearSupervisorApprovalHighlights();
          const pendingIds = new Set(
            pendingActivities
              .map((activity) =>
                String(activity && activity.id ? activity.id : "").trim(),
              )
              .filter(Boolean),
          );

          let firstMatch = null;
          document
            .querySelectorAll(".supervisor-activity-row")
            .forEach((row) => {
              const rowId = String(row.dataset.activityId || "").trim();
              const shouldHighlight = rowId && pendingIds.has(rowId);
              row.classList.toggle("is-approval-warning", shouldHighlight);
              if (shouldHighlight && !firstMatch) {
                firstMatch = row;
              }
            });

          if (firstMatch) {
            firstMatch.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        }

        async function submitReview(status) {
          if (!currentSupervisorReportId) {
            setSupervisorNotification(
              "Selecciona un informe para revisar.",
              true,
            );
            return;
          }

          const activitiesPayload = collectSupervisorActivities();
          if (status === "aprobado") {
            const pendingActivities =
              getPendingActivitiesForApproval(activitiesPayload);
            if (pendingActivities.length) {
              highlightPendingActivitiesForApproval(pendingActivities);
              openModal(
                "No se puede aprobar el informe",
                `<p>Para aprobar el informe, <strong>todas</strong> las actividades deben estar marcadas como <strong>Cumplida</strong>.</p><p>Aún hay ${pendingActivities.length} actividad(es) sin cumplir esta condición.</p>`,
              );
              setSupervisorNotification(
                "No se puede aprobar: marca todas las actividades como cumplidas.",
                true,
              );
              return;
            }
            clearSupervisorApprovalHighlights();
          }

          const response = await sendSupervisorReview(
            currentSupervisorReportId,
            {
              actividades: activitiesPayload,
              status,
              observacion_global: supervisorGlobalObservation.value,
            },
          );

          if (!response.ok) {
            if (
              status === "aprobado" &&
              response.error === "activities_not_completed"
            ) {
              openModal(
                "No se puede aprobar el informe",
                "<p>El sistema validó que aún existen actividades que no están en estado <strong>Cumplida</strong>.</p><p>Actualiza todas las actividades y vuelve a intentar.</p>",
              );
            }
            setSupervisorNotification("No se pudo guardar la revisión.", true);
            return;
          }

          if (status === "aprobado") {
            setSupervisorNotification(
              "Informe aprobado. Se notificará al contratista.",
            );
          } else if (status === "rechazado") {
            setSupervisorNotification(
              "Informe rechazado. Se notificará al contratista.",
            );
          } else {
            setSupervisorNotification("Revisión parcial guardada.");
          }

          await openSupervisorReviewPanel(currentSupervisorReportId);
          await renderSupervisorReportsTable();
        }

        async function renderSupervisorReportsTable() {
          if (!supervisorReportsMenu) {
            return;
          }
          supervisorReportsMenu.innerHTML = "";
          const reports = await fetchSupervisorReports();
          supervisorReportsCache = reports;
          updateSupervisorStats(reports);
          syncSupervisorSideLinks();
          const contractorFilter = (filterContractor.value || "")
            .trim()
            .toLowerCase();
          const periodFilter = filterPeriod.value || "";
          const statusFilter = filterStatus.value || "";

          const filtered = reports.filter((report) => {
            const contractor = String(report.contractor || "").toLowerCase();
            const period = String(report.period || "");
            const status = String(report.status || "");
            return (
              (!contractorFilter || contractor.includes(contractorFilter)) &&
              (!periodFilter || period === periodFilter) &&
              (!statusFilter || status === statusFilter)
            );
          });

          if (!filtered.length) {
            const empty = document.createElement("div");
            empty.className = "supervisor-menu-empty";
            empty.textContent = "No se encontraron informes con ese filtro.";
            supervisorReportsMenu.appendChild(empty);
            return;
          }

          for (const report of filtered) {
            const card = document.createElement("div");
            card.className = "supervisor-report-item";

            const reviewButton = document.createElement("button");
            reviewButton.type = "button";
            reviewButton.dataset.reportId = String(report.id);
            reviewButton.className = "supervisor-open-review";

            const contractor = document.createElement("strong");
            contractor.className = "supervisor-report-contractor";
            contractor.textContent = report.contractor || "Sin contratista";

            const meta = document.createElement("span");
            meta.className = "supervisor-report-period";
            meta.textContent = `Periodo: ${report.period || "Sin periodo"}`;

            const status = document.createElement("span");
            status.className = `supervisor-report-status is-${String(
              report.status || "pendiente",
            )}`;
            status.textContent = capitalize(report.status || "pendiente");

            reviewButton.appendChild(contractor);
            reviewButton.appendChild(meta);
            reviewButton.appendChild(status);

            const downloadLink = document.createElement("a");
            downloadLink.href = report.docUrl;
            downloadLink.target = "_blank";
            downloadLink.rel = "noopener noreferrer";
            downloadLink.textContent = "Descargar";
            downloadLink.className = "supervisor-report-download";

            card.appendChild(reviewButton);
            card.appendChild(downloadLink);
            supervisorReportsMenu.appendChild(card);
          }

          updateSupervisorLastSync();
          updateSupervisorActiveItem();
        }

        supervisorReportsMenu.addEventListener("click", (event) => {
          const button = event.target.closest("button.supervisor-open-review");
          if (!button) {
            return;
          }
          const reportId = Number(button.dataset.reportId || "0");
          if (!reportId) {
            return;
          }
          openSupervisorReviewPanel(reportId);
        });

        approveButton.addEventListener("click", () => submitReview("aprobado"));
        rejectButton.addEventListener("click", () => submitReview("rechazado"));
        draftButton.addEventListener("click", () => submitReview("pendiente"));

        document
          .getElementById("btn-filter-reports")
          .addEventListener("click", renderSupervisorReportsTable);
        supervisorSideLinks.forEach((button) => {
          button.addEventListener("click", () => {
            filterStatus.value = button.dataset.status || "";
            syncSupervisorSideLinks();
            renderSupervisorReportsTable();
          });
        });
        filterContractor.addEventListener(
          "input",
          renderSupervisorReportsTable,
        );
        filterPeriod.addEventListener("change", renderSupervisorReportsTable);
        filterStatus.addEventListener("change", () => {
          syncSupervisorSideLinks();
          renderSupervisorReportsTable();
        });
        if (supervisorRefreshButton) {
          supervisorRefreshButton.addEventListener(
            "click",
            renderSupervisorReportsTable,
          );
        }

        function showSupervisorSection() {
          document.getElementById("supervisor-review-section").style.display =
            "";
          if (supervisorEmptyState) {
            supervisorEmptyState.style.display = "";
          }
          renderSupervisorReportsTable();
        }

        showSupervisorSection();
      }
    </script>
  </body>
</html>
